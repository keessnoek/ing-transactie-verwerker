<!-- rapportages.html -->
{% extends "base.html" %}

{% block title %}Rapportages - ING Transactie Verwerker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-bar me-2"></i>Rapportages</h2>
        <p class="text-muted">Krijg inzicht in je uitgavenpatronen met overzichtelijke kruistabellen.</p>
    </div>
</div>

<!-- Jaar selectie -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-calendar me-2"></i>Jaar selecteren</h6>
                <select class="form-select" id="jaarSelect" onchange="laadKruistabel()">
                    {% for jaar in jaren %}
                    <option value="{{ jaar }}" {% if jaar == huidig_jaar %}selected{% endif %}>{{ jaar }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <h5 id="totaalInkomsten" class="transaction-positive">€0,00</h5>
                        <small class="text-muted">Totaal Inkomsten</small>
                    </div>
                    <div class="col-4">
                        <h5 id="totaalUitgaven" class="transaction-negative">€0,00</h5>
                        <small class="text-muted">Totaal Uitgaven</small>
                    </div>
                    <div class="col-4">
                        <h5 id="nettoResultaat">€0,00</h5>
                        <small class="text-muted">Netto Resultaat</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading indicator -->
<div id="loadingIndicator" class="text-center d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Laden...</span>
    </div>
    <p class="mt-2">Kruistabel wordt geladen...</p>
</div>

<!-- Kruistabel -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Uitgaven per Maand per Categorie - <span id="tabelJaar">{{ huidig_jaar }}</span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="kruistabelTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Categorie</th>
                                <th>Jan</th>
                                <th>Feb</th>
                                <th>Mrt</th>
                                <th>Apr</th>
                                <th>Mei</th>
                                <th>Jun</th>
                                <th>Jul</th>
                                <th>Aug</th>
                                <th>Sep</th>
                                <th>Okt</th>
                                <th>Nov</th>
                                <th>Dec</th>
                                <th class="table-dark">Totaal</th>
                            </tr>
                        </thead>
                        <tbody id="kruistabelBody">
                            <!-- Data wordt hier ingeladen via JavaScript -->
                        </tbody>
                        <tfoot class="table-dark">
                            <tr>
                                <th>Totaal</th>
                                <th id="totaal1">€0,00</th>
                                <th id="totaal2">€0,00</th>
                                <th id="totaal3">€0,00</th>
                                <th id="totaal4">€0,00</th>
                                <th id="totaal5">€0,00</th>
                                <th id="totaal6">€0,00</th>
                                <th id="totaal7">€0,00</th>
                                <th id="totaal8">€0,00</th>
                                <th id="totaal9">€0,00</th>
                                <th id="totaal10">€0,00</th>
                                <th id="totaal11">€0,00</th>
                                <th id="totaal12">€0,00</th>
                                <th id="grandTotal">€0,00</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not jaren %}
<div class="row">
    <div class="col-12">
        <div class="text-center mt-5">
            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Nog geen data voor rapportages</h5>
            <p class="text-muted">Begin met het <a href="{{ url_for('importeren') }}">importeren van transacties</a>.</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function formatBedrag(bedrag) {
    if (bedrag === 0) return '€0,00';
    
    const absValue = Math.abs(bedrag);
    const formatted = '€' + absValue.toFixed(2);
    
    // Kleur bepaling voor styling
    if (bedrag < 0) {
        return `<span class="transaction-negative">${formatted}</span>`;
    } else if (bedrag > 0) {
        return `<span class="transaction-positive">${formatted}</span>`;
    }
    return formatted;
}

function laadKruistabel() {
    const jaar = document.getElementById('jaarSelect').value;
    const loadingIndicator = document.getElementById('loadingIndicator');
    const kruistabelBody = document.getElementById('kruistabelBody');
    
    // Toon loading
    loadingIndicator.classList.remove('d-none');
    kruistabelBody.innerHTML = '<tr><td colspan="14" class="text-center">Laden...</td></tr>';
    
    // Update jaar in titel
    document.getElementById('tabelJaar').textContent = jaar;
    
    // Fetch data
    fetch(`/rapportages/kruistabel?jaar=${jaar}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Bouw tabel
            let html = '';
            
            // Sorteer categorieën alfabetisch, maar 'Zonder categorie' onderaan
            const sortedCategories = Object.keys(data.data).sort((a, b) => {
                if (a === 'Zonder categorie') return 1;
                if (b === 'Zonder categorie') return -1;
                return a.localeCompare(b);
            });
            
            sortedCategories.forEach(categorie => {
                const maandBedragen = data.data[categorie];
                const categorieTotaal = data.categorie_totalen[categorie];
                
                html += `<tr>`;
                html += `<td><strong>${categorie}</strong></td>`;
                
                // Bedragen per maand
                for (let maand = 1; maand <= 12; maand++) {
                    const bedrag = maandBedragen[maand] || 0;
                    html += `<td>${formatBedrag(bedrag)}</td>`;
                }
                
                // Totaal voor deze categorie
                html += `<td class="table-secondary"><strong>${formatBedrag(categorieTotaal)}</strong></td>`;
                html += `</tr>`;
            });
            
            kruistabelBody.innerHTML = html;
            
            // Update footer totalen
            for (let maand = 1; maand <= 12; maand++) {
                const totaal = data.maand_totalen[maand] || 0;
                document.getElementById(`totaal${maand}`).innerHTML = formatBedrag(totaal);
            }
            
            // Grand total
            document.getElementById('grandTotal').innerHTML = formatBedrag(data.grand_total);
            
            // Update samenvatting bovenaan
            updateSamenvatting(data);
            
        })
        .catch(error => {
            console.error('Error:', error);
            kruistabelBody.innerHTML = `<tr><td colspan="14" class="text-center text-danger">Fout bij laden: ${error.message}</td></tr>`;
        })
        .finally(() => {
            loadingIndicator.classList.add('d-none');
        });
}

function updateSamenvatting(data) {
    let totaalInkomsten = 0;
    let totaalUitgaven = 0;
    
    // Bereken totalen
    Object.values(data.categorie_totalen).forEach(bedrag => {
        if (bedrag > 0) {
            totaalInkomsten += bedrag;
        } else {
            totaalUitgaven += bedrag;
        }
    });
    
    const nettoResultaat = totaalInkomsten + totaalUitgaven; // Uitgaven zijn al negatief
    
    document.getElementById('totaalInkomsten').innerHTML = formatBedrag(totaalInkomsten);
    document.getElementById('totaalUitgaven').innerHTML = formatBedrag(totaalUitgaven);
    
    const nettoElement = document.getElementById('nettoResultaat');
    nettoElement.innerHTML = formatBedrag(nettoResultaat);
    nettoElement.className = nettoResultaat >= 0 ? 'transaction-positive' : 'transaction-negative';
}

// Laad kruistabel bij pagina load
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('jaarSelect').options.length > 0) {
        laadKruistabel();
    }
});
</script>
{% endblock %}